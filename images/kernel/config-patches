# In this file, the recipe for patching all kernel configs (all versions & architectures) is

# Enable wireguard
# https://github.com/weaveworks/ignite/issues/768
CONFIG_WIREGUARD=y

# Enable bonding/teaming
CONFIG_BONDING=y
CONFIG_NET_TEAM=y
CONFIG_NET_TEAM_MODE_BROADCAST=y
CONFIG_NET_TEAM_MODE_ROUNDROBIN=y
CONFIG_NET_TEAM_MODE_RANDOM=y
CONFIG_NET_TEAM_MODE_ACTIVEBACKUP=y
CONFIG_NET_TEAM_MODE_LOADBALANCE=y


# For making Weave Net work
CONFIG_DUMMY=y
# Enable VXLAN support as a module so that e.g. Flannel works
CONFIG_VXLAN=m
# Enable support for soft shutdown of amd64 VMs
# See https://github.com/firecracker-microvm/firecracker/blob/main/docs/api_requests/actions.md#sendctrlaltdel
CONFIG_KEYBOARD_ATKBD=y
CONFIG_SERIO=y
CONFIG_SERIO_I8042=y
CONFIG_SERIO_LIBPS2=y
# Make the guest's wall clock not drift
# https://github.com/firecracker-microvm/firecracker/blob/main/FAQ.md#my-guest-wall-clock-is-drifting-how-can-i-fix-it
CONFIG_PTP_1588_CLOCK=y
CONFIG_PTP_1588_CLOCK_KVM=y

# Some patches for keeping network functionalities that Kubernetes needs/might need
CONFIG_IPVLAN=y
CONFIG_IPVTAP=y
CONFIG_TAP=y
CONFIG_IP_VS_MH=m

# Enable /proc/config inside of the VM
# https://superuser.com/questions/287371/obtain-kernel-config-from-currently-running-linux-system
CONFIG_IKCONFIG=y
CONFIG_IKCONFIG_PROC=y

# Enable support for TCMU, required by most of the storage systems.
CONFIG_TCM_USER2=m

#
# Firecracker: Required for block and network devices
#
CONFIG_VIRTIO_BLK=y             # Support for virtio-blk device (used for rootfs)
CONFIG_VIRTIO_NET=y             # Support for virtio-net device (used for networking)
CONFIG_VIRTIO_MMIO=y            # Support for MMIO-based virtio (Firecracker uses MMIO, not PCI)

#
# Firecracker: Device file system support
#
CONFIG_DEVTMPFS=y               # Enables devtmpfs, needed to create /dev nodes
CONFIG_DEVTMPFS_MOUNT=y         # Mounts devtmpfs automatically at boot

#
# Firecracker: Serial console for I/O
#
CONFIG_SERIAL_8250=y            # Support for 8250 UART (used by Firecracker's ttyS0)
CONFIG_SERIAL_8250_CONSOLE=y    # Allow console output to ttyS0

#
# Filesystem support
#
CONFIG_EXT4=y                   # Enables ext4 support for root filesystem
CONFIG_TMPFS=y                  # Enables tmpfs (used in many init systems)
CONFIG_PROC_FS=y                # Enables /proc filesystem (useful for monitoring/debugging)
CONFIG_SYSFS=y                  # Enables /sys filesystem (device introspection)

#
# Firecracker: Networking stack
#
CONFIG_NET=y                    # Enable networking
CONFIG_NETDEVICES=y            # Enable network device core support

#
# Firecracker: Security features
#
CONFIG_STRICT_KERNEL_RWX=y     # Disallow W+X memory in kernel space
CONFIG_STRICT_MODULE_RWX=y     # Disallow W+X memory in kernel modules (if modules enabled)
CONFIG_SECURITY_DMESG_RESTRICT=y # Restrict dmesg access to privileged users
CONFIG_DEFAULT_MMAP_MIN_ADDR=65536 # Mitigate null pointer dereference attacks
CONFIG_SECCOMP=y               # Enable seccomp syscall filtering (Firecracker uses this)
CONFIG_SECCOMP_FILTER=y        # Enable custom seccomp filters

#
# Firecracker: Optional but useful
#
CONFIG_BLK_DEV_INITRD=y        # Support for initrd/initramfs if you're using one

#
# Firecracker: Disable unused subsystems for smaller and faster kernel
#
CONFIG_USB_SUPPORT=n           # Disable USB support (Firecracker has no USB devices)
CONFIG_SND=n                   # Disable sound support
CONFIG_INPUT=n                 # Disable input subsystem (no keyboard/mouse in Firecracker)
CONFIG_MODULES=n               # Disable loadable module support (Firecracker expects monolithic kernels)
CONFIG_ACPI=n                  # Disable ACPI (Firecracker uses Device Tree instead)
