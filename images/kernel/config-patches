# In this file, the recipe for patching all kernel configs (all versions & architectures) is

# Needed to properly mount the rootfs.
CONFIG_PCI=y
CONFIG_VIRTIO_MMIO_CMDLINE_DEVICES=y

# Needed for docker:
CONFIG_NF_CONNTRACK=y
CONFIG_NF_CONNTRACK_MARK=y
CONFIG_NF_CONNTRACK_EVENTS=y
CONFIG_NF_CONNTRACK_PROCFS=y
CONFIG_NF_CONNTRACK_IPV4=y
CONFIG_NETFILTER_NETLINK_LOG=y
CONFIG_NETFILTER_NETLINK_QUEUE=y
CONFIG_NF_TABLES_BRIDGE=y
CONFIG_NFT_BRIDGE_META=y
CONFIG_NETFILTER_XT_MATCH_BRIDGE=y
CONFIG_IP_NF_RAW=y
CONFIG_NF_TABLES=y
CONFIG_NF_TABLES_INET=y
CONFIG_NF_TABLES_IPV4=y
CONFIG_NF_TABLES_IPV6=y
CONFIG_NFT_CHAIN_NAT_IPV4=y
CONFIG_NFT_CHAIN_NAT_IPV6=y
CONFIG_NFT_NAT=y
CONFIG_NF_NAT=y
CONFIG_NETFILTER_XT_MATCH_IPVS=y
CONFIG_NETFILTER_XT_MARK=y
CONFIG_NF_TABLES_NETDEV=y
CONFIG_NFT_CHAIN_ROUTE_IPV4=y
CONFIG_NFT_CHAIN_ROUTE_IPV6=y
CONFIG_NFT_REJECT=y
CONFIG_NFT_REJECT_IPV4=y
CONFIG_NFT_REJECT_IPV6=y
CONFIG_NFT_MASQ=y
CONFIG_NFT_DUP_NETDEV=y
CONFIG_NFT_NUMGEN=y
CONFIG_NFT_LOG=y
CONFIG_NFT_QUOTA=y
CONFIG_NFT_LIMIT=y
CONFIG_NETFILTER_XT_MATCH_STATE=y
CONFIG_NETFILTER_XT_MATCH_TCPMSS=y
CONFIG_NETFILTER_XT_MATCH_MULTIPORT=y
CONFIG_NETFILTER_XT_MATCH_COMMENT=y
CONFIG_NETFILTER_XT_MATCH_LIMIT=y
CONFIG_NETFILTER_XT_MATCH_MAC=y
CONFIG_NETFILTER_XT_MATCH_LENGTH=y
CONFIG_NETFILTER_XT_MATCH_PKTTYPE=y
CONFIG_NETFILTER_XT_TARGET_ACCEPT=y
CONFIG_NETFILTER_XT_TARGET_REJECT=y
CONFIG_NETFILTER_XT_TARGET_LOG=y
CONFIG_NETFILTER_XT_TARGET_MASQUERADE=y
CONFIG_NETFILTER_XT_TARGET_REDIRECT=y
CONFIG_NETFILTER_XT_TARGET_NFLOG=y
CONFIG_NETFILTER_XT_MATCH_IPVS=y
CONFIG_IP6_NF_RAW=y
CONFIG_IP_VS=y
CONFIG_IP_VS_NFCT=y
CONFIG_BRIDGE_VLAN_FILTERING=y
CONFIG_NET_CLS_CGROUP=y
CONFIG_MEMCG_SWAP=y
CONFIG_IP_VS_PROTO_TCP=y
CONFIG_IP_VS_PROTO_UDP=y
CONFIG_IP_VS_RR=y
CONFIG_BRIDGE_VLAN_FILTERING=y
CONFIG_CRYPTO_GCM=y
CONFIG_CRYPTO_GHASH=y
CONFIG_INET_ESP=y
CONFIG_NETFILTER_XT_MATCH_BPF=y

# Enable wireguard
# https://github.com/weaveworks/ignite/issues/768
CONFIG_WIREGUARD=y

# Enable bonding/teaming
CONFIG_BONDING=y
CONFIG_NET_TEAM=y
CONFIG_NET_TEAM_MODE_BROADCAST=y
CONFIG_NET_TEAM_MODE_ROUNDROBIN=y
CONFIG_NET_TEAM_MODE_RANDOM=y
CONFIG_NET_TEAM_MODE_ACTIVEBACKUP=y
CONFIG_NET_TEAM_MODE_LOADBALANCE=y


# For making Weave Net work
CONFIG_DUMMY=y
# Enable VXLAN support as a module so that e.g. Flannel works
CONFIG_VXLAN=y
# Enable support for soft shutdown of amd64 VMs
# See https://github.com/firecracker-microvm/firecracker/blob/main/docs/api_requests/actions.md#sendctrlaltdel
CONFIG_INPUT_KEYBOARD=y
CONFIG_KEYBOARD_ATKBD=y

CONFIG_SERIO=y
CONFIG_SERIO_I8042=y
CONFIG_SERIO_LIBPS2=y
# Make the guest's wall clock not drift
# https://github.com/firecracker-microvm/firecracker/blob/main/FAQ.md#my-guest-wall-clock-is-drifting-how-can-i-fix-it
CONFIG_PTP_1588_CLOCK=y
CONFIG_PTP_1588_CLOCK_KVM=y

# Some patches for keeping network functionalities that Kubernetes needs/might need
CONFIG_IPVLAN=y
CONFIG_IPVTAP=y
CONFIG_TAP=y
CONFIG_IP_VS_MH=m

# Enable /proc/config inside of the VM
# https://superuser.com/questions/287371/obtain-kernel-config-from-currently-running-linux-system
CONFIG_IKCONFIG=y
CONFIG_IKCONFIG_PROC=y

# Enable support for TCMU, required by most of the storage systems.
CONFIG_TCM_USER2=m

#
# Firecracker: Required for block and network devices
#
CONFIG_VIRTIO_BLK=y             # Support for virtio-blk device (used for rootfs)
CONFIG_VIRTIO_NET=y             # Support for virtio-net device (used for networking)
CONFIG_VIRTIO_MMIO=y            # Support for MMIO-based virtio (Firecracker uses MMIO, not PCI)

#
# Firecracker: Device file system support
#
CONFIG_DEVTMPFS=y               # Enables devtmpfs, needed to create /dev nodes
CONFIG_DEVTMPFS_MOUNT=y         # Mounts devtmpfs automatically at boot

#
# Firecracker: Serial console for I/O
#
CONFIG_SERIAL_8250=y            # Support for 8250 UART (used by Firecracker's ttyS0)
CONFIG_SERIAL_8250_CONSOLE=y    # Allow console output to ttyS0

#
# Filesystem support
#
CONFIG_EXT4=y                   # Enables ext4 support for root filesystem
CONFIG_TMPFS=y                  # Enables tmpfs (used in many init systems)
CONFIG_PROC_FS=y                # Enables /proc filesystem (useful for monitoring/debugging)
CONFIG_SYSFS=y                  # Enables /sys filesystem (device introspection)

#
# Firecracker: Networking stack
#
CONFIG_NET=y                    # Enable networking
CONFIG_NETDEVICES=y            # Enable network device core support

#
# Firecracker: Security features
#
CONFIG_STRICT_KERNEL_RWX=y     # Disallow W+X memory in kernel space
CONFIG_STRICT_MODULE_RWX=y     # Disallow W+X memory in kernel modules (if modules enabled)
CONFIG_SECURITY_DMESG_RESTRICT=y # Restrict dmesg access to privileged users
CONFIG_DEFAULT_MMAP_MIN_ADDR=65536 # Mitigate null pointer dereference attacks
CONFIG_SECCOMP=y               # Enable seccomp syscall filtering (Firecracker uses this)
CONFIG_SECCOMP_FILTER=y        # Enable custom seccomp filters

#
# Firecracker: Optional but useful
#
CONFIG_BLK_DEV_INITRD=y        # Support for initrd/initramfs if you're using one

#
# Firecracker: Disable unused subsystems for smaller and faster kernel
#
CONFIG_USB_SUPPORT=n           # Disable USB support (Firecracker has no USB devices)
CONFIG_SND=n                   # Disable sound support
CONFIG_INPUT=n                 # Disable input subsystem (no keyboard/mouse in Firecracker)
CONFIG_MODULES=n               # Disable loadable module support (Firecracker expects monolithic kernels)
CONFIG_ACPI=n                  # Disable ACPI (Firecracker uses Device Tree instead)
